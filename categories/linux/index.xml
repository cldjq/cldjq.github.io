<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Linux on 承离的觉前</title>
    <link>https://tinklespring.com/categories/linux/</link>
    <description>Recent content in Linux on 承离的觉前</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Mon, 22 May 2023 16:51:53 +0800</lastBuildDate>
    
        <atom:link href="https://tinklespring.com/categories/linux/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>https://tinklespring.com/about/</link>
      <pubDate>Mon, 22 May 2023 18:33:06 +0800</pubDate>
      
      <guid>https://tinklespring.com/about/</guid>
      <description>&lt;p&gt;Super man!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Rsync&#43;inotify数据实时同步</title>
      <link>https://tinklespring.com/posts/rsync&#43;inotify%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/</link>
      <pubDate>Mon, 22 May 2023 16:51:53 +0800</pubDate>
      
      <guid>https://tinklespring.com/posts/rsync&#43;inotify%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5/</guid>
      <description>&lt;blockquote&gt;
&lt;p&gt;不啰嗦,不介绍rsync用法,直接实现使用&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;rsyncdconf配置&#34;&gt;rsyncd.conf配置&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# vim /etc/rsyncd.conf
port=873
log file=/var/log/rsync.log
pid file=/var/run/rsyncd.pid
[test]
path=/home/test_server
use chroot=true
max connections=4
read only=no
list=false
uid=root
gid=root
auth users=test
secrets file=/etc/rsync.pass
hosts allow=192.168.0.31
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;auth users 与系统用户没有任何关系,只在这里指定使用.
secrets file 是auth users这个用户的信息,内容格式 : &lt;code&gt;test:123456&lt;/code&gt;,为了安全,将此文件更改为600的权限.&lt;/p&gt;
&lt;h4 id=&#34;启动&#34;&gt;启动&lt;/h4&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# rsync --daemon
# ss -lntp |grep rsync
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可以查看到rsync服务的873的端口&lt;/p&gt;
&lt;h3 id=&#34;安装inotify-tools&#34;&gt;安装inotify-tools&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz
# yum install –y gcc
# mkdir /usr/local/inotify
# tar -xzf inotify-tools-3.14.tar.gz
# cd inotify-tools-3.14
# ./configure --prefix=/usr/local/inotify/
# make &amp;amp;&amp;amp; make install
# echo &amp;#39;export PATH=/usr/local/inotify/bin/:$PATH&amp;#39; &amp;gt;&amp;gt; /etc/profile
# . /etc/profile
# echo &amp;#39;/usr/local/inotify/lib&amp;#39; &amp;gt;&amp;gt; /etc/ld.so.conf --加载库文件
# ldconfig
# ln -s /usr/local/inotify/include /usr/include/inotify
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;常用参数&#34;&gt;常用参数&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;-m —始终保持监听状态，默认触发事件即退出
-r —递归查询目录
-q —打印出监控事件
-e —定义监控的事件，可用参数：
access —访问文件
modify —修改文件
attrib —属性变更
open —打开文件
delete —删除文件
create —新建文件
move —文件移动
—fromfile —从文件读取需要监视的文件或者排除的文件，一个文件一行，排除的文件以@开头
—timefmt —时间格式
—format —输出格式
—exclude —正则匹配需要排除的文件，大小写敏感
—excludei —正则匹配需要排除的文件，忽略大小写
%y%m%d %H%M —年月日时钟
%T%w%f%e —时间路径文件名状态
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;查看系统是否支持&#34;&gt;查看系统是否支持&lt;/h4&gt;
&lt;p&gt;使用&lt;code&gt;ll /proc/sys/fs/inotify&lt;/code&gt;命令，是否有以下三条信息输出，如果没有表示不支持。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;-rw-r--r-- 1 root root 0 Dec 11 15:23 max_queued_events
-rw-r--r-- 1 root root 0 Dec 11 15:23 max_user_instances
-rw-r--r-- 1 root root 0 Dec 11 15:23 max_user_watches
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;max_queued_events&lt;/code&gt;表示调用inotify_init时分配给inotify instance中可排队的event的数目的最大值，超出这个值的事件被丢弃，但会触发IN_Q_OVERFLOW事件。
&lt;code&gt;/proc/sys/fs/inotify/max_user_instances&lt;/code&gt;表示每一个real user ID可创建的inotify instatnces的数量上限。
&lt;code&gt;/proc/sys/fs/inotify/max_user_watches&lt;/code&gt;表示每个inotify instatnces可监控的最大目录数量。如果监控的文件数目巨大，需要根据情况，适当增加此值的大小。&lt;/p&gt;
&lt;h3 id=&#34;编辑同步脚本&#34;&gt;编辑同步脚本&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#!/bin/bash
/usr/local/inotify/bin/inotifywait -mrq -e modify,create,move,delete,attrib /home/test31/test31 | while read events
do
rsync -a --bwlimit=200 /home/test31/test31 test@192.168.0.30::test --password-file=/home/password.txt
echo &amp;#34;`date +&amp;#39;%F %T&amp;#39;` 出现事件：$events&amp;#34; &amp;gt;&amp;gt; /tmp/rsync.log 2&amp;gt;&amp;amp;1
done
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;--password-file&lt;/code&gt;这个参数用来写auth users的密码,权限也改为600
&lt;code&gt;--bwlimit=200&lt;/code&gt;这个参数限制传输速率为200kb,若不限制,会导致巨大的CPU消耗.&lt;/p&gt;
&lt;p&gt;当然,也可以在目标机器上也写一个这样的脚本,用来实现双向同步&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>